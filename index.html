<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ç®€å¹»æ¬¢å®ä¾‹åˆ›å»º&å˜é…å·¥å…·ï¼Œæ”¯æŒè·å–ç®€å¹»æ¬¢ Tokenã€åˆ›å»ºå®ä¾‹ã€è‡ªåŠ¨åˆ›å»ºä»¥åŠå®ä¾‹å˜é…å’Œè‡ªåŠ¨å˜é…ç­‰åŠŸèƒ½ã€‚">
    <title>ç®€å¹»æ¬¢å®ä¾‹åˆ›å»º&å˜é…å·¥å…·</title>
    <style>
        :root {
            --primary: #1976d2;
            --primary-hover: #1565c0;
            --success: #2e7d32;
            --error: #d32f2f;
            --warning: #f57c00;
            --text-main: #333;
            --text-sec: #666;
            --bg-body: #f5f7fa;
            --bg-card: #ffffff;
            --border: #e0e0e0;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.05), 0 1px 3px rgba(0, 0, 0, 0.1);
            --radius: 8px;
        }

        * {
            box-sizing: border-box;
            outline: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: var(--bg-body);
            margin: 0;
            padding: 20px;
            color: var(--text-main);
            line-height: 1.6;
            font-size: 16px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header & UserInfo */
        header {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 24px 36px;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            margin: 0;
            font-size: 1.75rem;
            color: var(--text-main);
        }

        .user-info {
            font-size: 1.05rem;
            color: var(--text-sec);
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .pro-badge {
            background: linear-gradient(135deg, #1976d2, #42a5f5);
            color: white;
            padding: 3px 10px;
            border-radius: 14px;
            font-size: 0.85rem;
            font-weight: bold;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 30px;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Tutorial Section */
        .tutorial-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            -webkit-user-select: none;
            user-select: none;
            border-bottom: 1px solid var(--border);
            padding-bottom: 12px;
            margin-bottom: 12px;
        }

        .tutorial-content {
            display: none;
            padding: 12px 0;
        }

        .tutorial.expanded .tutorial-content {
            display: block;
        }

        .tutorial.expanded .toggle-icon {
            transform: rotate(180deg);
        }

        .toggle-icon {
            transition: transform 0.3s;
            color: var(--text-sec);
            font-size: 1rem;
        }

        ol {
            padding-left: 24px;
            color: var(--text-sec);
            font-size: 1rem;
        }

        li {
            margin-bottom: 12px;
        }

        /* Inputs & Buttons */
        .input-group {
            display: flex;
            gap: 12px;
            margin-top: 18px;
            max-width: 600px;
        }

        input[type="text"],
        input[type="number"],
        input[type="password"] {
            flex: 1;
            padding: 12px 18px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        input:focus {
            border-color: var(--primary);
        }

        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background 0.2s, transform 0.1s;
            white-space: nowrap;
        }

        button:hover {
            background: var(--primary-hover);
        }

        button:active {
            transform: scale(0.98);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        button.danger {
            background: var(--error);
        }

        button.danger:hover {
            background: #b71c1c;
        }

        button.outline {
            background: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
        }

        button.outline:hover {
            background: rgba(25, 118, 210, 0.05);
        }

        button.success {
            background: var(--success);
        }

        button.success:hover {
            background: #1b5e20;
        }

        .bookmarklet {
            display: inline-block;
            background: var(--text-main);
            color: #fff;
            padding: 6px 18px;
            border-radius: 4px;
            text-decoration: none;
            font-size: 14px;
            margin-left: 8px;
        }

        /* Mode Switcher */
        .mode-switch {
            display: flex;
            justify-content: center;
            margin-bottom: 24px;
            background: #e0e0e0;
            border-radius: 8px;
            padding: 6px;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }

        .mode-btn {
            padding: 10px 28px;
            border-radius: 6px;
            background: transparent;
            color: var(--text-sec);
            box-shadow: none;
        }

        .mode-btn.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            border: 1px solid var(--border);
            border-radius: 8px;
            max-height: 700px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1100px;
        }

        thead th,
        tfoot th {
            background: #f8f9fa;
            padding: 14px 16px;
            text-align: left;
            font-weight: 600;
            color: var(--text-sec);
            position: sticky;
            font-size: 16px;
            white-space: nowrap;
            box-sizing: border-box;
        }

        thead th {
            top: 0;
            z-index: 10;
            border-bottom: 2px solid var(--border);
        }

        tfoot th {
            bottom: 0;
            z-index: 10;
            border-top: 2px solid var(--border);
            border-bottom: none;
        }

        thead th.sortable,
        tfoot th.sortable {
            cursor: pointer;
            -webkit-user-select: none;
            user-select: none;
        }

        thead th.sortable:hover,
        tfoot th.sortable:hover {
            background: #eeeeee;
        }

        /* Sort Icons */
        .sort-icon {
            display: inline-block;
            margin-left: 8px;
            font-size: 14px;
            vertical-align: middle;
        }

        .sort-icon.primary {
            color: var(--primary);
            opacity: 1;
            font-weight: bold;
        }

        .sort-icon.secondary {
            color: var(--text-sec);
            opacity: 0.7;
            font-size: 12px;
            margin-left: 4px;
        }

        td {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
            color: var(--text-sec);
            font-size: 16px;
        }

        tbody tr {
            cursor: pointer;
            transition: background 0.2s;
        }

        tbody tr:hover {
            background: #f5f5f5;
        }

        tbody tr.selected {
            background: #e3f2fd;
            border-left: 4px solid var(--primary);
        }

        tbody tr.creatable-row {
            background: rgba(46, 125, 50, 0.05);
        }

        .status-tag {
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
        }

        .status-yes {
            color: var(--success);
            background: #e8f5e9;
        }

        .status-no {
            color: var(--error);
            background: #ffebee;
        }

        .status-warning {
            color: var(--warning);
            background: #fff3e0;
        }

        /* Actions Panel */
        .actions-panel {
            text-align: center;
            padding: 24px;
            background: #fafafa;
            border-radius: 8px;
            margin-top: 24px;
            border: 1px dashed var(--border);
        }

        .actions-panel p {
            margin: 8px 0;
            font-size: 16px;
            color: var(--text-sec);
        }

        .main-action-btn {
            padding: 14px 48px;
            font-size: 18px;
            margin-top: 18px;
        }

        .action-buttons-group {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 18px;
            flex-wrap: wrap;
        }

        .create-mode-toggle {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin-bottom: 18px;
            font-size: 16px;
        }

        .create-mode-toggle label {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Toast Notifications */
        #toast-container {
            position: fixed;
            top: 24px;
            right: 24px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .toast {
            min-width: 300px;
            padding: 18px 24px;
            background: white;
            border-left: 6px solid var(--primary);
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            animation: slideIn 0.3s ease-out;
            font-size: 16px;
        }

        .toast.success {
            border-left-color: var(--success);
        }

        .toast.error {
            border-left-color: var(--error);
        }

        .toast.warning {
            border-left-color: var(--warning);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Auto Progress */
        .progress-bar-container {
            width: 100%;
            height: 6px;
            background: #e0e0e0;
            margin-top: 12px;
            border-radius: 3px;
            overflow: hidden;
            display: none;
        }

        .progress-bar {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width linear;
        }

        /* Loading Spinner */
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 12px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .hidden {
            display: none !important;
        }

        /* CPU Link */
        .cpu-grade-link {
            text-align: center;
            margin-bottom: 18px;
        }

        .cpu-grade-link a {
            color: var(--primary);
            text-decoration: none;
            font-size: 1rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .cpu-grade-link a:hover {
            text-decoration: underline;
        }

        /* Responsive */
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                align-items: flex-start;
                gap: 18px;
            }

            .user-info {
                width: 100%;
                flex-wrap: wrap;
                font-size: 1rem;
            }

            .input-group {
                flex-direction: column;
                max-width: 100%;
            }

            button {
                width: 100%;
            }

            .action-buttons-group {
                flex-direction: column;
            }
        }

        /* Sort Mode Switch */
        .sort-mode-switch {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            color: var(--text-sec);
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        input:checked+.slider {
            background-color: var(--primary);
        }

        input:checked+.slider:before {
            transform: translateX(24px);
        }

        .sort-mode-label {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .sort-mode-label.active {
            color: var(--primary);
            font-weight: 500;
        }

        .mode-switch-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin: 15px 0;
            font-size: 14px;
        }

        .mode-label {
            color: var(--text-sec);
            transition: color 0.3s;
        }

        .mode-label.active {
            color: var(--primary);
            font-weight: bold;
        }

        /* Utility Classes (Refactored from inline styles) */
        .tutorial-title {
            margin: 0;
            font-size: 1.1rem;
            color: var(--primary);
        }

        .text-primary {
            color: var(--primary);
        }

        .text-bold-primary {
            font-weight: bold;
            color: var(--primary);
        }

        .text-sec {
            color: var(--text-sec);
        }

        .text-muted-sm {
            font-size: 0.9rem;
            color: #666;
        }

        .text-warning {
            color: var(--warning);
        }

        .text-bold {
            font-weight: bold;
        }

        .text-bold-mt {
            margin-top: 5px;
            font-weight: bold;
        }

        .text-small-gray {
            font-size: 12px;
            color: #999;
        }

        .u-m-0 {
            margin: 0;
        }

        .u-mt-0 {
            margin-top: 0;
        }

        .u-mt-10 {
            margin-top: 10px;
        }

        .u-mt-15 {
            margin-top: 15px;
        }

        .u-mt-30 {
            margin-top: 30px;
        }

        .u-mb-15 {
            margin-bottom: 15px;
        }

        .u-my-15 {
            margin: 15px 0;
        }

        .u-flex-1 {
            flex: 1;
        }

        .u-flex-center {
            display: flex;
            align-items: center;
        }

        .u-flex-between {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .u-flex-wrap {
            flex-wrap: wrap;
        }

        .u-gap-5 {
            gap: 5px;
        }

        .u-gap-10 {
            gap: 10px;
        }

        .u-gap-15 {
            gap: 15px;
        }

        .section-header {
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .btn-small-outline {
            font-size: 12px;
            padding: 5px 10px;
            border-color: #ccc;
            color: #666;
        }

        .btn-xs {
            padding: 6px 12px;
            font-size: 12px;
        }

        .input-xs {
            width: 80px;
        }

        .link-inherit {
            color: inherit;
            text-decoration: none;
        }

        .user-info-inner {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .user-credits {
            font-size: 0.85rem;
            color: #666;
        }

        .username-copy {
            cursor: pointer;
            font-weight: bold;
        }

        .loading-area {
            text-align: center;
            padding: 40px;
            display: none;
        }

        .loading-text {
            margin-top: 10px;
            color: var(--text-sec);
        }

        .error-area {
            text-align: center;
            padding: 20px;
            color: var(--error);
            display: none;
        }

        .footer {
            text-align: center;
            margin-top: 30px;
            color: #999;
            font-size: 12px;
        }

        .spinner-lg {
            width: 40px;
            height: 40px;
            border-width: 4px;
        }
    </style>
</head>

<body>

    <div id="toast-container"></div>

    <div class="container">
        <header>
            <h1>ç®€å¹»æ¬¢å®ä¾‹åˆ›å»º&å˜é…å·¥å…·</h1>
            <div id="userInfo" class="user-info">
                <span class="placeholder">æœªç™»å½•</span>
            </div>
        </header>

        <!-- Token / Tutorial Section -->
        <section id="tutorial" class="card tutorial expanded">
            <div id="tutorialHeader" class="tutorial-header">
                <h2 class="tutorial-title">ğŸ”‘ é¦–æ¬¡ä½¿ç”¨ & Token è®¾ç½®</h2>
                <span class="toggle-icon">â–¼</span>
            </div>
            <div class="tutorial-content">
                <ol>
                    <li>å°†ä¸‹æ–¹æŒ‰é’®æ‹–æ‹½åˆ°æµè§ˆå™¨æ”¶è—å¤¹ï¼š
                        <a href="javascript:(function(){const t=localStorage.getItem('token');if(t&&t!=='null'){navigator.clipboard.writeText(t).then(()=>alert('âœ… Token å·²æˆåŠŸè·å–å¹¶å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼')).catch(()=>alert('è·å–æˆåŠŸä½†å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ï¼š'+t));}else{alert('âŒ è·å–å¤±è´¥ï¼šæ‰¾ä¸åˆ° Tokenã€‚è¯·ç¡®ä¿æ‚¨å·²ç™»å½•ä¸”å¤„äºç®€å¹»æ¬¢æ§åˆ¶å°é¡µé¢ã€‚');}})();"
                            class="bookmarklet">ç®€å¹»æ¬¢Tokenè·å–</a>
                    </li>
                    <li>è®¿é—® <a href="https://simpfun.cn/console" target="_blank" rel="noopener"
                            class="text-primary">ç®€å¹»æ¬¢å®˜ç½‘</a>
                        å¹¶ç™»å½•ï¼Œç‚¹å‡»æ”¶è—å¤¹æŒ‰é’®è·å– Tokenã€‚</li>
                    <li>
                        <div class="input-group u-mt-10">
                            <input type="password" id="tokenInput" placeholder="åœ¨æ­¤ç²˜è´´ Token" aria-label="Token Input">
                            <button id="submitTokenBtn" class="u-flex-1">æäº¤ Token</button>
                        </div>
                    </li>
                    <li>æäº¤åï¼Œé…ç½®åˆ—è¡¨å°†è‡ªåŠ¨åŠ è½½ã€‚</li>
                </ol>
                <div class="u-mt-15">
                    <button id="clearTokenBtn" class="outline btn-small-outline">æ¸…é™¤å·²ä¿å­˜çš„
                        Token</button>
                </div>
            </div>
        </section>

        <!-- Mode Switcher -->
        <div class="mode-switch">
            <button class="mode-btn active" id="modeCreateBtn">åˆ›å»ºå®ä¾‹æ¨¡å¼</button>
            <button class="mode-btn" id="modeInstanceBtn">æˆ‘çš„å®ä¾‹æ¨¡å¼</button>
        </div>

        <!-- Main Content Area -->
        <main class="card">
            <div id="loadingArea" class="loading-area">
                <div class="spinner spinner-lg"></div>
                <p class="loading-text">æ­£åœ¨åŠ è½½æ•°æ®...</p>
            </div>

            <!-- Config Table Section -->
            <section id="createModeSection">
                <div class="section-header">
                    <h3 class="u-m-0">å¯ç”¨é…ç½®åˆ—è¡¨</h3>
                    <div class="header-controls">
                        <div class="sort-mode-switch">
                            <span class="sort-mode-label active" id="singleSortLabel">å•æ’åº</span>
                            <label class="switch" for="sortModeToggle">
                                <input type="checkbox" id="sortModeToggle">
                                <span class="slider"></span>
                            </label>
                            <span class="sort-mode-label" id="dualSortLabel">åŒé‡æ’åº</span>
                        </div>
                        <button id="refreshBtn" class="outline btn-xs">åˆ·æ–°åˆ—è¡¨</button>
                    </div>
                </div>

                <!-- CPU Grade Link -->
                <!-- CPU Grade Link -->
                <div class="cpu-grade-link">
                    <a href="https://yuque.com/simpfun/sfe/areas" target="_blank" rel="noopener">
                        ğŸ“„ ç‚¹å‡»æŸ¥çœ‹å®ä¾‹ CPU ç­‰çº§è¯´æ˜
                    </a>
                </div>

                <div class="table-container">
                    <table id="configTable">
                        <thead>
                            <tr>
                                <th class="sortable" data-key="id">ID</th>
                                <th class="sortable" data-key="area_grade">CPUç­‰çº§</th>
                                <th class="sortable" data-key="area_vendor">ä¾›åº”å•†</th>
                                <th class="sortable" data-key="cpu">CPUæ ¸å¿ƒ</th>
                                <th class="sortable" data-key="ram">å†…å­˜</th>
                                <th class="sortable" data-key="disk">ç£ç›˜</th>
                                <th class="sortable" data-key="traffic">æµé‡</th>
                                <th class="sortable" data-key="point">ç§¯åˆ†</th>
                                <th class="sortable" data-key="spec">è§„æ ¼</th>
                                <th class="sortable" data-key="creatable">çŠ¶æ€</th>
                            </tr>
                        </thead>
                        <tbody id="configBody"></tbody>
                        <tfoot>
                            <tr>
                                <th class="sortable" data-key="id">ID</th>
                                <th class="sortable" data-key="area_grade">CPUç­‰çº§</th>
                                <th class="sortable" data-key="area_vendor">ä¾›åº”å•†</th>
                                <th class="sortable" data-key="cpu">CPUæ ¸å¿ƒ</th>
                                <th class="sortable" data-key="ram">å†…å­˜</th>
                                <th class="sortable" data-key="disk">ç£ç›˜</th>
                                <th class="sortable" data-key="traffic">æµé‡</th>
                                <th class="sortable" data-key="point">ç§¯åˆ†</th>
                                <th class="sortable" data-key="spec">è§„æ ¼</th>
                                <th class="sortable" data-key="creatable">çŠ¶æ€</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div id="createActionArea" class="actions-panel hidden">
                    <h3 class="u-mt-0">æ“ä½œé¢æ¿</h3>
                    <p>å½“å‰é€‰ä¸­é…ç½®ï¼š<span id="selectedConfigName" class="text-bold-primary">--</span></p>

                    <!-- Create Mode Toggle -->
                    <div id="createModeToggleArea" class="mode-switch-container">
                        <span id="createSingleLabel" class="mode-label active">å•æ¬¡åˆ›å»º</span>
                        <label class="switch">
                            <input type="checkbox" id="createModeSwitch" onchange="simpCreateApp.toggleCreateUI()">
                            <span class="slider"></span>
                        </label>
                        <span id="createLoopLabel" class="mode-label">å¾ªç¯åˆ›å»º</span>
                    </div>

                    <!-- Single Create UI -->
                    <div id="singleCreateUI">
                        <p class="text-muted-sm">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å‘é€ä¸€æ¬¡åˆ›å»ºè¯·æ±‚ã€‚</p>
                        <button id="createBtn" class="main-action-btn">ç«‹å³åˆ›å»ºå®ä¾‹</button>
                    </div>

                    <!-- Loop Create UI -->
                    <div id="loopCreateUI" class="hidden">
                        <p class="text-warning">å¾ªç¯åˆ›å»ºæ¨¡å¼å°†æŒ‰ç…§è®¾å®šé—´éš”æŒç»­å‘é€è¯·æ±‚ï¼Œè¯·æ³¨æ„è´¦å·é£é™©ã€‚</p>
                        <div class="u-my-15">
                            <label for="intervalInput">è¯·æ±‚é—´éš”(ç§’): </label>
                            <input type="number" id="intervalInput" value="30" min="10" class="input-xs">
                        </div>
                        <button id="autoCreateBtn" class="main-action-btn danger">å¼€å§‹å¾ªç¯åˆ›å»º</button>
                        <div id="createProgressContainer" class="progress-bar-container">
                            <div id="createProgressBar" class="progress-bar"></div>
                        </div>
                        <p id="repeatCount" class="text-bold-mt">å·²å‘é€è¯·æ±‚: 0 æ¬¡</p>
                    </div>
                </div>
            </section>

            <!-- Instances Table Section -->
            <section id="instanceModeSection" class="hidden">
                <div class="section-header">
                    <h3 class="u-m-0">æˆ‘çš„å®ä¾‹åˆ—è¡¨</h3>
                    <div class="sort-mode-switch">
                        <span class="sort-mode-label active" id="singleSortLabelInst">å•æ’åº</span>
                        <label class="switch" for="sortModeToggleInst">
                            <input type="checkbox" id="sortModeToggleInst">
                            <span class="slider"></span>
                        </label>
                        <span class="sort-mode-label" id="dualSortLabelInst">åŒé‡æ’åº</span>
                    </div>
                </div>

                <div class="table-container">
                    <table id="instancesTable">
                        <thead>
                            <tr>
                                <th class="sortable" data-key="id">å®ä¾‹ID</th>
                                <th class="sortable" data-key="status">çŠ¶æ€</th>
                                <th class="sortable" data-key="area_grade">å½“å‰å®ä¾‹ç±»å‹</th>
                                <th class="sortable" data-key="cpu">CPUæ ¸å¿ƒ</th>
                                <th class="sortable" data-key="ram">å†…å­˜</th>
                                <th class="sortable" data-key="disk">ç£ç›˜</th>
                                <th class="sortable" data-key="port">ç«¯å£</th>
                                <th class="sortable" data-key="traffic">å‰©ä½™æµé‡/æ€»æµé‡</th>
                                <th class="sortable" data-key="point">ç§¯åˆ†</th>
                            </tr>
                        </thead>
                        <tbody id="instancesBody"></tbody>
                        <tfoot>
                            <tr>
                                <th class="sortable" data-key="id">å®ä¾‹ID</th>
                                <th class="sortable" data-key="status">çŠ¶æ€</th>
                                <th class="sortable" data-key="area_grade">å½“å‰å®ä¾‹ç±»å‹</th>
                                <th class="sortable" data-key="cpu">CPUæ ¸å¿ƒ</th>
                                <th class="sortable" data-key="ram">å†…å­˜</th>
                                <th class="sortable" data-key="disk">ç£ç›˜</th>
                                <th class="sortable" data-key="port">ç«¯å£</th>
                                <th class="sortable" data-key="traffic">å‰©ä½™æµé‡/æ€»æµé‡</th>
                                <th class="sortable" data-key="point">ç§¯åˆ†</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div id="reconfigActionArea" class="actions-panel hidden">
                    <h3 class="u-mt-0">å®ä¾‹æ§åˆ¶é¢æ¿</h3>

                    <div class="u-mb-15" style="border-bottom: 1px solid #eee; padding-bottom: 5px;">
                        <p>å½“å‰é€‰ä¸­å®ä¾‹ï¼š<span id="selectedInstanceName" class="text-bold"></span> (<span
                                id="currentInstanceSpec"></span>)</p>

                        <!-- Power Section -->
                        <div class="control-section u-mt-10">
                            <h4 class="u-m-0" style="font-size: 0.9rem; color: #666;">ç”µæºç®¡ç†</h4>
                            <div class="mode-switch-container" style="margin: 10px 0;">
                                <span id="powerSingleLabel" class="mode-label active">å•æ¬¡å¼€æœº</span>
                                <label class="switch">
                                    <input type="checkbox" id="powerModeSwitch"
                                        onchange="simpCreateApp.togglePowerUI()">
                                    <span class="slider"></span>
                                </label>
                                <span id="powerLoopLabel" class="mode-label">å¾ªç¯å¼€æœº</span>
                            </div>
                        </div>

                        <div id="singlePowerUI">
                            <button id="startInstanceBtn" class="main-action-btn success"
                                style="margin-top: 0; padding: 10px 30px;">ç«‹å³å¼€æœº</button>
                        </div>

                        <div id="loopPowerUI" class="hidden">
                            <div class="u-my-10">
                                <label for="powerIntervalInput" style="font-size: 14px;">é—´éš”(ç§’): </label>
                                <input type="number" id="powerIntervalInput" value="30" min="10" class="input-xs">
                                <button id="autoStartBtn" class="danger"
                                    style="padding: 8px 20px; font-size: 14px; margin-left: 10px;">å¼€å§‹å¾ªç¯å¼€æœº</button>
                            </div>
                            <div id="powerProgressContainer" class="progress-bar-container" style="margin-top: 5px;">
                                <div id="powerProgressBar" class="progress-bar"></div>
                            </div>
                            <p id="powerRepeatCount" class="text-small-gray u-mt-0">å·²å‘é€è¯·æ±‚: 0 æ¬¡</p>
                        </div>
                    </div>

                    <!-- Reconfig Section -->
                    <div class="control-section">
                        <h4 class="u-m-0" style="font-size: 0.9rem; color: #666;">è§„æ ¼å˜é…</h4>
                        <p>ç›®æ ‡é…ç½®ï¼š<span id="targetConfigName" class="text-bold-primary">--</span> (è¯·åœ¨åˆ—è¡¨é€‰æ‹©)</p>

                        <div id="reconfigModeToggleArea" class="mode-switch-container" style="margin: 10px 0;">
                            <span id="reconfigSingleLabel" class="mode-label active">å•æ¬¡å˜é…</span>
                            <label class="switch">
                                <input type="checkbox" id="reconfigModeSwitch"
                                    onchange="simpCreateApp.toggleReconfigUI()">
                                <span class="slider"></span>
                            </label>
                            <span id="reconfigLoopLabel" class="mode-label">å¾ªç¯å˜é…</span>
                        </div>
                    </div>

                    <div id="singleReconfigUI">
                        <button id="reconfigureBtn" class="main-action-btn"
                            style="margin-top: 0; padding: 10px 30px;">æ‰§è¡Œå˜é…</button>
                    </div>

                    <div id="loopReconfigUI" class="hidden">
                        <p id="loopReconfigMsg" class="text-warning hidden" style="font-size: 13px; margin: 5px 0;">
                            è¯¥é…ç½®ä¸å¯åˆ›å»ºï¼Œå·²è‡ªåŠ¨åˆ‡æ¢ä¸ºå¾ªç¯æ¨¡å¼</p>
                        <div class="u-my-10">
                            <label for="instanceIntervalInput" style="font-size: 14px;">é—´éš”(ç§’): </label>
                            <input type="number" id="instanceIntervalInput" value="30" min="10" class="input-xs">
                            <button id="autoReconfigureBtn" class="danger"
                                style="padding: 8px 20px; font-size: 14px; margin-left: 10px;">å¼€å§‹å¾ªç¯å˜é…</button>
                        </div>
                        <div id="reconfigProgressContainer" class="progress-bar-container" style="margin-top: 5px;">
                            <div id="reconfigProgressBar" class="progress-bar"></div>
                        </div>
                        <p id="reconfigRepeatCount" class="text-small-gray u-mt-0">å·²å‘é€è¯·æ±‚: 0 æ¬¡</p>
                    </div>
                </div>
            </section>

            <div id="errorArea" class="error-area"></div>
        </main>

        <footer class="footer">
            <p>ä½¿ç”¨æ­¤å·¥å…·äº§ç”Ÿçš„ä»»ä½•åæœç”±ä½¿ç”¨è€…è‡ªè¡Œæ‰¿æ‹…ã€‚</p>
            <a href="https://github.com/zhazha7hao/simpcreate" target="_blank" rel="noopener"
                class="link-inherit">GitHub
                Project</a>
        </footer>
    </div>

    <script>
        /**
         * Toast Notification System
         */
        const Toast = {
            container: document.getElementById('toast-container'),
            show(message, type = 'info', duration = 3000) {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `
            <span>${message}</span>
            <span style="cursor:pointer; margin-left:10px; opacity:0.6" onclick="this.parentElement.remove()">âœ•</span>
        `;
                this.container.appendChild(toast);

                if (duration > 0) {
                    setTimeout(() => {
                        toast.style.animation = 'slideIn 0.3s reverse';
                        setTimeout(() => toast.remove(), 300);
                    }, duration);
                }
            },
            success(msg) { this.show(msg, 'success'); },
            error(msg) { this.show(msg, 'error', 5000); },
            warning(msg) { this.show(msg, 'warning'); }
        };

        /**
         * Main Application Logic
         */
        const simpCreateApp = {
            config: {
                VERSION_ID: '191',
                API_BASE: 'https://api.simpfun.cn/api',
                GRADE_ORDER: ["C+", "C++", "B-", "B", "B+", "B++", "A", "S-", "S", "S+"],
                SPEC_ORDER: ["M", "M+", "L", "L+", "XL", "2XL", "3XL"],
                MIN_INTERVAL: 10
            },
            state: {
                token: null,
                selectedConfig: null,
                selectedInstanceId: null,
                selectedInstanceData: null,
                isInstanceMode: false,
                isDualSort: false,
                primarySortKey: 'area_grade',
                primarySortAsc: true,
                secondarySortKey: null,
                secondarySortAsc: true,
                createIntervalId: null,
                reconfigIntervalId: null,
                powerIntervalId: null,
                createRepeatCount: 0,
                reconfigRepeatCount: 0,
                powerRepeatCount: 0,
                isLoadingDetail: false,
                cachedConfigs: []
            },
            elements: {},

            init() {
                this.cacheDOM();
                this.bindEvents();

                const storedToken = this.getCookie('sf_token');
                if (storedToken) {
                    this.state.token = storedToken;
                    this.elements.tokenInput.value = storedToken;
                    this.elements.tutorial.classList.remove('expanded');
                    this.elements.refreshBtn.style.display = 'block';
                    this.refreshData(true);
                }

                this.updateSortHeaders();
            },

            cacheDOM() {
                const ids = [
                    'tutorial', 'tutorialHeader', 'tokenInput', 'submitTokenBtn', 'clearTokenBtn',
                    'loadingArea', 'errorArea',
                    'configTable', 'configBody', 'createModeSection', 'instanceModeSection',
                    'modeCreateBtn', 'modeInstanceBtn', 'refreshBtn',
                    'createActionArea', 'selectedConfigName', 'createBtn',
                    'singleCreateUI', 'loopCreateUI', 'autoCreateBtn',
                    'intervalInput', 'repeatCount', 'createProgressContainer', 'createProgressBar',
                    'instancesTable', 'instancesBody', 'reconfigActionArea', 'selectedInstanceName',
                    'currentInstanceSpec',
                    'targetConfigName', 'reconfigureBtn', 'startInstanceBtn',
                    'createModeSwitch', 'createSingleLabel', 'createLoopLabel', 'createModeToggleArea',
                    'reconfigModeSwitch', 'reconfigSingleLabel', 'reconfigLoopLabel', 'reconfigModeToggleArea',
                    'powerModeSwitch', 'powerSingleLabel', 'powerLoopLabel',
                    'singleReconfigUI', 'loopReconfigUI', 'loopReconfigMsg',
                    'autoReconfigureBtn', 'instanceIntervalInput', 'reconfigProgressContainer', 'reconfigProgressBar', 'reconfigRepeatCount',
                    'singlePowerUI', 'loopPowerUI', 'powerIntervalInput', 'autoStartBtn',
                    'powerProgressContainer', 'powerProgressBar', 'powerRepeatCount',
                    'userInfo',
                    'sortModeToggle', 'sortModeToggleInst', 'singleSortLabel', 'dualSortLabel',
                    'singleSortLabelInst', 'dualSortLabelInst'
                ];
                ids.forEach(id => this.elements[id] = document.getElementById(id));
            },

            bindEvents() {
                this.elements.submitTokenBtn.addEventListener('click', () => this.submitToken());
                this.elements.clearTokenBtn.addEventListener('click', () => this.clearToken());

                this.elements.tutorialHeader.addEventListener('click', () => {
                    this.elements.tutorial.classList.toggle('expanded');
                });

                this.elements.modeCreateBtn.addEventListener('click', () => this.switchMode(false));
                this.elements.modeInstanceBtn.addEventListener('click', () => this.switchMode(true));

                this.elements.sortModeToggle.addEventListener('change', (e) => this.toggleSortMode(e.target.checked));
                this.elements.sortModeToggleInst.addEventListener('change', (e) => this.toggleSortMode(e.target.checked));

                this.elements.refreshBtn.addEventListener('click', () => this.refreshData());
                this.elements.createBtn.addEventListener('click', () => this.createInstance());
                this.elements.autoCreateBtn.addEventListener('click', () => this.toggleAutoCreate());

                this.elements.reconfigureBtn.addEventListener('click', () => this.reconfigureInstance(false));
                this.elements.startInstanceBtn.addEventListener('click', () => this.startInstance(false));
                this.elements.autoReconfigureBtn.addEventListener('click', () => this.toggleAutoReconfig());
                this.elements.autoStartBtn.addEventListener('click', () => this.toggleAutoPower());

                document.addEventListener('click', (e) => {
                    const th = e.target.closest('th.sortable');
                    if (th) {
                        this.handleSortClick(th);
                    }
                });

                document.body.addEventListener('click', async (e) => {
                    if (e.target.classList.contains('clickable-copy')) {
                        const text = e.target.dataset.copy;
                        try {
                            await navigator.clipboard.writeText(text);
                            Toast.show(`å·²å¤åˆ¶: ${text}`, 'success', 1500);
                        } catch (err) {
                            Toast.show('å¤åˆ¶å¤±è´¥', 'error');
                        }
                    }
                });
            },

            toggleSortMode(isDual) {
                this.state.isDualSort = isDual;

                this.elements.sortModeToggle.checked = isDual;
                this.elements.sortModeToggleInst.checked = isDual;

                if (isDual) {
                    this.elements.singleSortLabel.classList.remove('active');
                    this.elements.dualSortLabel.classList.add('active');
                    this.elements.singleSortLabelInst.classList.remove('active');
                    this.elements.dualSortLabelInst.classList.add('active');
                } else {
                    this.elements.dualSortLabel.classList.remove('active');
                    this.elements.singleSortLabel.classList.add('active');
                    this.elements.dualSortLabelInst.classList.remove('active');
                    this.elements.singleSortLabelInst.classList.add('active');

                    this.state.secondarySortKey = null;
                }

                this.renderConfigs();
                this.renderInstances(this.state.cachedInstances || []);
                this.updateSortHeaders();

                Toast.success(isDual ? 'å·²å¯ç”¨åŒé‡æ’åºï¼Œç‚¹å‡»ä¸¤åˆ—å¯è®¾ç½®ä¸»æ¬¡æ’åº' : 'å·²åˆ‡æ¢ä¸ºå•æ’åºæ¨¡å¼', 2000);
            },

            handleSortClick(th) {
                const key = th.dataset.key;
                const isPrimary = (this.state.primarySortKey === key);
                const isSecondary = (this.state.secondarySortKey === key);

                if (!this.state.isDualSort) {
                    if (isPrimary) {
                        this.state.primarySortAsc = !this.state.primarySortAsc;
                    } else {
                        this.state.primarySortKey = key;
                        this.state.primarySortAsc = true;
                    }
                } else {
                    if (isPrimary) {
                        this.state.primarySortAsc = !this.state.primarySortAsc;
                    } else if (isSecondary) {
                        this.state.secondarySortAsc = !this.state.secondarySortAsc;
                    } else {
                        if (this.state.secondarySortKey === null) {
                            this.state.secondarySortKey = key;
                            this.state.secondarySortAsc = true;
                        } else {
                            this.state.primarySortKey = key;
                            this.state.primarySortAsc = true;
                            this.state.secondarySortKey = null;
                        }
                    }
                }

                this.renderConfigs();
                this.renderInstances(this.state.cachedInstances || []);
                this.updateSortHeaders();
            },

            updateSortHeaders() {
                document.querySelectorAll('th.sortable').forEach(th => {
                    const baseText = th.childNodes[0].textContent.trim();
                    th.innerHTML = baseText;

                    const key = th.dataset.key;

                    if (key === this.state.primarySortKey) {
                        const arrow = this.state.primarySortAsc ? 'â–¼' : 'â–²';
                        th.innerHTML += ` <span class="sort-icon primary">${arrow}</span>`;
                    }
                    else if (this.state.isDualSort && key === this.state.secondarySortKey) {
                        const arrow = this.state.secondarySortAsc ? 'â–¼' : 'â–²';
                        th.innerHTML += ` <span class="sort-icon secondary">${arrow}</span>`;
                    }
                });
            },

            getSortValue(item, key) {
                let val = item[key];

                if (key === 'traffic') {
                    if (val && typeof val === 'object' && 'remain_bytes' in val) {
                        return val.remain_bytes;
                    }
                    const num = Number(val);
                    return isNaN(num) ? 0 : num;
                }

                if (key === 'area_grade') {
                    return this.config.GRADE_ORDER.indexOf(val);
                } else if (key === 'spec') {
                    return this.config.SPEC_ORDER.indexOf(val);
                }

                if (key === 'creatable') {
                    return val ? 1 : 0;
                }

                if (key === 'port') {
                    return item.default_allocation ? item.default_allocation.port : 0;
                }

                if (key === 'status') {
                    const statusMap = { 'running': 3, 'starting': 2, 'offline': 1 };
                    return statusMap[val] || 0;
                }

                const num = parseFloat(val);
                return isNaN(num) ? String(val).toLowerCase() : num;
            },

            sortData(data) {
                return [...data].sort((a, b) => {
                    let valA = this.getSortValue(a, this.state.primarySortKey);
                    let valB = this.getSortValue(b, this.state.primarySortKey);

                    if (valA < valB) return this.state.primarySortAsc ? -1 : 1;
                    if (valA > valB) return this.state.primarySortAsc ? 1 : -1;

                    if (this.state.isDualSort && this.state.secondarySortKey) {
                        let valA2 = this.getSortValue(a, this.state.secondarySortKey);
                        let valB2 = this.getSortValue(b, this.state.secondarySortKey);

                        if (valA2 < valB2) return this.state.secondarySortAsc ? -1 : 1;
                        if (valA2 > valB2) return this.state.secondarySortAsc ? 1 : -1;
                    }

                    return 0;
                });
            },

            getCachedInstances() {
                return this.state.cachedInstances || [];
            },

            toggleCreateUI() {
                const isLoop = this.elements.createModeSwitch.checked;
                if (isLoop) {
                    this.elements.singleCreateUI.classList.add('hidden');
                    this.elements.loopCreateUI.classList.remove('hidden');
                    this.elements.createSingleLabel.classList.remove('active');
                    this.elements.createLoopLabel.classList.add('active');
                } else {
                    this.elements.singleCreateUI.classList.remove('hidden');
                    this.elements.loopCreateUI.classList.add('hidden');
                    this.elements.createSingleLabel.classList.add('active');
                    this.elements.createLoopLabel.classList.remove('active');
                    if (this.state.createIntervalId) this.stopAutoCreate();
                }
            },

            toggleReconfigUI() {
                const isLoop = this.elements.reconfigModeSwitch.checked;
                if (isLoop) {
                    this.elements.singleReconfigUI.classList.add('hidden');
                    this.elements.loopReconfigUI.classList.remove('hidden');
                    this.elements.reconfigSingleLabel.classList.remove('active');
                    this.elements.reconfigLoopLabel.classList.add('active');
                } else {
                    this.elements.singleReconfigUI.classList.remove('hidden');
                    this.elements.loopReconfigUI.classList.add('hidden');
                    this.elements.reconfigSingleLabel.classList.add('active');
                    this.elements.reconfigLoopLabel.classList.remove('active');
                    this.elements.loopReconfigMsg.classList.add('hidden');

                    if (this.state.reconfigIntervalId) this.stopAutoReconfig();
                }
            },

            togglePowerUI() {
                const isLoop = this.elements.powerModeSwitch.checked;
                if (isLoop) {
                    this.elements.singlePowerUI.classList.add('hidden');
                    this.elements.loopPowerUI.classList.remove('hidden');
                    this.elements.powerSingleLabel.classList.remove('active');
                    this.elements.powerLoopLabel.classList.add('active');
                } else {
                    this.elements.singlePowerUI.classList.remove('hidden');
                    this.elements.loopPowerUI.classList.add('hidden');
                    this.elements.powerSingleLabel.classList.add('active');
                    this.elements.powerLoopLabel.classList.remove('active');
                    if (this.state.powerIntervalId) this.stopAutoPower();
                }
            },

            async apiFetch(endpoint, options = {}) {
                const url = `${this.config.API_BASE}${endpoint}`;
                const headers = { 'Authorization': this.state.token, 'Accept': 'application/json', ...options.headers };

                try {
                    const response = await fetch(url, { ...options, headers });
                    if (response.status === 401) throw new Error('Token æ— æ•ˆæˆ–å·²è¿‡æœŸ');
                    const data = await response.json();
                    if (!response.ok || data.code !== 200) throw new Error(data.msg || `HTTP Error ${response.status}`);
                    return data;
                } catch (error) {
                    throw error;
                }
            },

            async refreshData(isInit = false) {
                this.toggleLoading(true);
                this.elements.errorArea.style.display = 'none';
                try {
                    await Promise.all([
                        this.getUserInfo(),
                        this.loadConfigs()
                    ]);
                    if (this.state.isInstanceMode) await this.loadInstances();
                    if (!isInit) Toast.success('æ•°æ®åˆ·æ–°æˆåŠŸ');
                } catch (error) {
                    this.elements.errorArea.textContent = error.message;
                    this.elements.errorArea.style.display = 'block';
                    if (error.message.includes('Token')) this.clearToken(false);
                } finally {
                    this.toggleLoading(false);
                }
            },

            async getUserInfo() {
                const data = await this.apiFetch("/auth/info?");
                const info = data.info;
                const proBadge = info.is_pro ? '<span class="pro-badge">PRO</span>' : '';
                this.elements.userInfo.innerHTML = `
            <div class="user-info-inner">
                <span class="clickable-copy username-copy" data-copy="${info.username}">ğŸ‘¤ ${info.username}</span>
                ${proBadge}
            </div>
            <div class="user-credits">
                UID: <span class="clickable-copy" data-copy="${info.id}">${info.id}</span> | 
                ç§¯åˆ†: ${info.point} | 
                é’»çŸ³: ${info.diamond}
            </div>
        `;
            },

            async loadConfigs() {
                const data = await this.apiFetch(`/shop/list?version_id=${this.config.VERSION_ID}`);
                this.state.cachedConfigs = data.list;
                this.renderConfigs();
            },

            async loadInstances() {
                try {
                    const listData = await this.apiFetch('/ins/list?');
                    const instanceIds = listData.list.map(item => item.id);

                    if (instanceIds.length === 0) {
                        this.renderInstances([]);
                        this.state.cachedInstances = [];
                        return;
                    }

                    const detailPromises = instanceIds.map(id => this.apiFetch(`/ins/${id}/detail`));
                    const detailResponses = await Promise.all(detailPromises);

                    const detailMap = {};
                    detailResponses.forEach(res => {
                        if (res && res.data) {
                            detailMap[res.data.id] = res.data;
                        }
                    });

                    const finalInstances = listData.list.map(listItem => {
                        const detailItem = detailMap[listItem.id] || {};
                        return { ...listItem, ...detailItem };
                    });

                    this.state.cachedInstances = finalInstances;
                    this.renderInstances(finalInstances);
                } catch (error) {
                    console.error('åŠ è½½å®ä¾‹å¤±è´¥:', error);
                    Toast.error(`åŠ è½½å®ä¾‹å¤±è´¥: ${error.message}`);
                }
            },

            renderConfigs() {
                const data = this.sortData(this.state.cachedConfigs);

                const tbody = this.elements.configBody;
                tbody.innerHTML = '';
                const fragment = document.createDocumentFragment();

                data.forEach(cfg => {
                    const tr = document.createElement('tr');
                    if (cfg.creatable) tr.className = 'creatable-row';
                    if (this.state.selectedConfig && this.state.selectedConfig.id === cfg.id) tr.classList.add('selected');

                    tr.innerHTML = `
                <td>${cfg.id}</td>
                <td>${cfg.area_grade}</td>
                <td>${cfg.area_vendor}</td>
                <td>${cfg.cpu}</td>
                <td>${cfg.ram}GB</td>
                <td>${cfg.disk}GB</td>
                <td>${cfg.traffic}GB</td>
                <td>${cfg.point}</td>
                <td>${cfg.spec}</td>
                <td><span class="status-tag ${cfg.creatable ? 'status-yes' : 'status-no'}">${cfg.creatable ? 'å¯åˆ›å»º' : 'ä¸å¯åˆ›å»º'}</span></td>
            `;

                    tr.addEventListener('click', () => this.selectConfig(cfg));
                    fragment.appendChild(tr);
                });
                tbody.appendChild(fragment);
            },

            renderInstances(instances) {
                const data = this.sortData(instances || []);

                const tbody = this.elements.instancesBody;
                tbody.innerHTML = '';
                const fragment = document.createDocumentFragment();

                if (!data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:30px;">æš‚æ— å®ä¾‹</td></tr>';
                    this.elements.reconfigActionArea.classList.add('hidden');
                    return;
                }

                data.forEach(ins => {
                    const tr = document.createElement('tr');
                    if (this.state.selectedInstanceId === ins.id) tr.classList.add('selected');

                    let trafficInfo = '-';
                    if (ins.traffic && typeof ins.traffic === 'object' && ins.traffic.plan) {
                        const remainGB = (ins.traffic.remain_bytes / (1024 * 1024 * 1024)).toFixed(2);
                        const totalGB = ins.traffic.plan;
                        trafficInfo = `${remainGB}GB / ${totalGB}GB`;
                    } else if (ins.traffic_plan) {
                        trafficInfo = `${ins.traffic_plan}GB`;
                    }

                    const statusMap = {
                        'running': { text: 'è¿è¡Œä¸­', class: 'status-yes' },
                        'starting': { text: 'å¯åŠ¨ä¸­', class: 'status-warning' },
                        'offline': { text: 'ç¦»çº¿', class: 'status-no' }
                    };
                    const status = statusMap[ins.status] || { text: ins.status, class: '' };
                    const port = ins.default_allocation ? ins.default_allocation.port : '-';

                    tr.innerHTML = `
    <td>${ins.id}</td>
    <td><span class="status-tag ${status.class}">${status.text}</span></td>
    <td>${ins.area_grade || '-'}</td>
    <td>${ins.cpu}æ ¸</td>
    <td>${ins.ram}GB</td>
    <td>${ins.disk}GB</td>
    <td>${port}</td>
    <td>${trafficInfo}</td>
    <td>${ins.point}</td>
`;
                    tr.addEventListener('click', () => this.selectInstance(ins, tr));
                    fragment.appendChild(tr);
                });
                tbody.appendChild(fragment);
            },

            selectConfig(cfg) {
                this.state.selectedConfig = cfg;

                this.renderConfigs();

                this.elements.selectedConfigName.textContent = `${cfg.area_grade} / ${cfg.spec} (${cfg.cpu}C/${cfg.ram}G)`;
                this.elements.targetConfigName.textContent = this.elements.selectedConfigName.textContent;

                this.elements.createActionArea.classList.remove('hidden');

                // Logic to disable loop create if config is creatable
                if (cfg.creatable) {
                    // Force single mode
                    this.elements.createModeSwitch.checked = false;
                    this.toggleCreateUI();
                    this.elements.createModeToggleArea.classList.add('hidden');
                } else {
                    this.elements.createModeToggleArea.classList.remove('hidden');
                }

                if (this.state.isInstanceMode && this.state.selectedInstanceId) {
                    this.updateReconfigControls(cfg);
                }
            },

            selectInstance(ins, rowEl) {
                this.state.selectedInstanceId = ins.id;
                this.state.selectedInstanceData = ins;

                this.elements.selectedInstanceName.textContent = `${ins.name || ins.id}`;
                if (this.elements.currentInstanceSpec) {
                    this.elements.currentInstanceSpec.textContent = `${ins.area_grade || 'æœªçŸ¥'} (${ins.cpu}C/${ins.ram}G)`;
                }

                document.querySelectorAll('#instancesBody tr').forEach(tr => tr.classList.remove('selected'));
                rowEl.classList.add('selected');

                this.elements.reconfigActionArea.classList.remove('hidden');

                // Requirement 1: Always show power controls
                this.togglePowerUI();

                if (this.state.selectedConfig) {
                    this.updateReconfigControls(this.state.selectedConfig);
                } else {
                    this.elements.targetConfigName.textContent = "è¯·å…ˆåœ¨ä¸Šæ–¹åˆ›å»ºåˆ—è¡¨ä¸­ç‚¹å‡»é€‰æ‹©ä¸€ä¸ªç›®æ ‡é…ç½®";
                    this.elements.reconfigModeToggleArea.classList.add('hidden');
                    this.elements.singleReconfigUI.classList.add('hidden');
                    this.elements.loopReconfigUI.classList.add('hidden');
                }
            },

            updateReconfigControls(targetCfg) {
                this.elements.targetConfigName.textContent = `${targetCfg.area_grade} / ${targetCfg.spec} (${targetCfg.cpu}C/${targetCfg.ram}G)`;

                if (targetCfg.creatable) {
                    // Config is available: allow both modes, default to single, but hide toggle per request
                    this.elements.reconfigModeSwitch.checked = false;
                    this.elements.reconfigModeToggleArea.classList.add('hidden');
                    this.elements.loopReconfigMsg.classList.add('hidden');
                    this.toggleReconfigUI();
                } else {
                    // Config is NOT available: force loop mode and show toggle (to indicate why it's looping)
                    this.elements.reconfigModeToggleArea.classList.remove('hidden');
                    this.elements.reconfigModeSwitch.checked = true;
                    this.elements.loopReconfigMsg.classList.remove('hidden');
                    this.toggleReconfigUI();
                }
            },

            switchMode(toInstanceMode) {
                this.state.isInstanceMode = toInstanceMode;

                if (toInstanceMode) {
                    this.elements.modeCreateBtn.classList.remove('active');
                    this.elements.modeInstanceBtn.classList.add('active');
                    this.elements.createModeSection.classList.add('hidden');
                    this.elements.instanceModeSection.classList.remove('hidden');

                    this.elements.sortModeToggleInst.checked = this.state.isDualSort;
                    if (this.state.isDualSort) {
                        this.elements.singleSortLabelInst.classList.remove('active');
                        this.elements.dualSortLabelInst.classList.add('active');
                    } else {
                        this.elements.dualSortLabelInst.classList.remove('active');
                        this.elements.singleSortLabelInst.classList.add('active');
                    }

                    if (this.state.token) {
                        this.loadInstances();
                        this.elements.reconfigActionArea.classList.add('hidden');
                    }
                } else {
                    this.elements.modeInstanceBtn.classList.remove('active');
                    this.elements.modeCreateBtn.classList.add('active');
                    this.elements.instanceModeSection.classList.add('hidden');
                    this.elements.createModeSection.classList.remove('hidden');
                }
            },

            async createInstance() {
                const btn = this.elements.createBtn;
                const originalText = btn.textContent;
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner"></span> åˆ›å»ºä¸­...';

                try {
                    const url = `${this.config.API_BASE}/ins/create`;
                    const body = `item_id=${this.state.selectedConfig.id}&version_id=${this.config.VERSION_ID}`;

                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Authorization': this.state.token,
                            'Accept': 'application/json',
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: body
                    });

                    const data = await response.json();

                    if (!response.ok || data.code !== 200) {
                        throw new Error(data.msg || `HTTP ${response.status}`);
                    }

                    // åˆ·æ–°é…ç½®åˆ—è¡¨
                    await this.loadConfigs();

                    // ğŸ”§ ä¿®å¤ï¼šåˆ›å»ºæˆåŠŸåï¼Œæ— è®ºé…ç½®æ˜¯å¦ä»å¯åˆ›å»ºï¼Œéƒ½åœæ­¢å¾ªç¯åˆ›å»º
                    if (this.state.createIntervalId) {
                        this.stopAutoCreate();
                        Toast.success('å®ä¾‹åˆ›å»ºæˆåŠŸï¼å·²è‡ªåŠ¨åœæ­¢å¾ªç¯åˆ›å»º', 4000);
                    } else {
                        Toast.success('å®ä¾‹åˆ›å»ºæˆåŠŸï¼');
                    }

                } catch (error) {
                    Toast.error(`åˆ›å»ºå¤±è´¥: ${error.message}`);
                } finally {
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            },

            async reconfigureInstance(isAuto = false) {
                const btn = isAuto ? this.elements.autoReconfigureBtn : this.elements.reconfigureBtn;
                const originalText = btn.textContent;

                if (!isAuto) {
                    btn.disabled = true;
                    btn.textContent = 'å˜é…ä¸­...';
                }

                try {
                    const body = JSON.stringify({ item_id: this.state.selectedConfig.id });
                    await this.apiFetch(`/ins/${this.state.selectedInstanceId}/change`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body
                    });
                    this.loadInstances();

                    // ğŸ”§ ä¿®å¤ï¼šå˜é…æˆåŠŸåï¼Œæ ¹æ®æ¨¡å¼æ˜¾ç¤ºä¸åŒæç¤º
                    if (isAuto) {
                        this.stopAutoReconfig();
                        Toast.success('å˜é…æˆåŠŸï¼å·²è‡ªåŠ¨åœæ­¢å¾ªç¯å˜é…', 4000);
                    } else {
                        Toast.success('å˜é…è¯·æ±‚æˆåŠŸï¼');
                    }
                } catch (error) {
                    Toast.error(`å˜é…å¤±è´¥: ${error.message}`);
                    if (!isAuto) {
                        btn.disabled = false;
                        btn.textContent = originalText;
                    }
                } finally {
                    if (!isAuto) {
                        btn.disabled = false;
                        btn.textContent = originalText;
                    }
                }
            },

            async startInstance(isAuto = false) {
                const btn = isAuto ? this.elements.autoStartBtn : this.elements.startInstanceBtn;
                const originalText = btn.textContent;

                if (!isAuto) {
                    btn.disabled = true;
                    btn.innerHTML = '<span class="spinner"></span> å¼€æœºä¸­...';
                }

                try {
                    const data = await this.apiFetch(`/ins/${this.state.selectedInstanceId}/power?action=start`);
                    if (isAuto) {
                        this.stopAutoPower();
                        Toast.success('å¼€æœºæˆåŠŸï¼å·²è‡ªåŠ¨åœæ­¢å¾ªç¯å¼€æœº');
                    } else {
                        Toast.success(data.msg || 'å¼€æœºæˆåŠŸ');
                    }
                } catch (error) {
                    if (!isAuto) Toast.error(`å¼€æœºå¤±è´¥: ${error.message}`);
                } finally {
                    if (!isAuto) {
                        btn.disabled = false;
                        btn.textContent = originalText;
                    }
                }
            },

            toggleAutoCreate() {
                if (this.state.createIntervalId) {
                    this.stopAutoCreate();
                } else {
                    this.startAutoTask('create');
                }
            },

            toggleAutoReconfig() {
                if (this.state.reconfigIntervalId) {
                    this.stopAutoReconfig();
                } else {
                    this.startAutoTask('reconfig');
                }
            },

            toggleAutoPower() {
                if (this.state.powerIntervalId) {
                    this.stopAutoPower();
                } else {
                    this.startAutoTask('power');
                }
            },

            startAutoTask(type) {
                let intervalInput, btn, progressBar, progressContainer, countEl, action;

                if (type === 'create') {
                    intervalInput = this.elements.intervalInput;
                    btn = this.elements.autoCreateBtn;
                    progressContainer = this.elements.createProgressContainer;
                    progressBar = this.elements.createProgressBar;
                    countEl = this.elements.repeatCount;
                    action = () => this.createInstance();
                } else if (type === 'reconfig') {
                    intervalInput = this.elements.instanceIntervalInput;
                    btn = this.elements.autoReconfigureBtn;
                    progressContainer = this.elements.reconfigProgressContainer;
                    progressBar = this.elements.reconfigProgressBar;
                    countEl = this.elements.reconfigRepeatCount;
                    action = () => this.reconfigureInstance(true);
                } else if (type === 'power') {
                    intervalInput = this.elements.powerIntervalInput;
                    btn = this.elements.autoStartBtn;
                    progressContainer = this.elements.powerProgressContainer;
                    progressBar = this.elements.powerProgressBar;
                    countEl = this.elements.powerRepeatCount;
                    action = () => this.startInstance(true);
                }

                let interval = parseInt(intervalInput.value);
                if (isNaN(interval) || interval < this.config.MIN_INTERVAL) {
                    Toast.warning(`é—´éš”æ—¶é—´å·²è‡ªåŠ¨è°ƒæ•´ä¸ºæœ€å°å€¼ ${this.config.MIN_INTERVAL} ç§’`);
                    interval = this.config.MIN_INTERVAL;
                    intervalInput.value = interval;
                }

                btn.textContent = 'åœæ­¢';
                btn.classList.add('danger');
                intervalInput.disabled = true;
                progressContainer.style.display = 'block';
                if (type === 'create') {
                    this.state.createRepeatCount = 0;
                    countEl.textContent = `å·²å‘é€è¯·æ±‚: 0 æ¬¡`;
                } else if (type === 'reconfig') {
                    this.state.reconfigRepeatCount = 0;
                    countEl.textContent = `å·²å‘é€è¯·æ±‚: 0 æ¬¡`;
                } else {
                    this.state.powerRepeatCount = 0;
                    countEl.textContent = `å·²å‘é€è¯·æ±‚: 0 æ¬¡`;
                }

                const runLoop = async () => {
                    if (!this.state.token) return;

                    progressBar.style.transition = 'none';
                    progressBar.style.width = '0%';
                    setTimeout(() => {
                        progressBar.style.transition = `width ${interval}s linear`;
                        progressBar.style.width = '100%';
                    }, 50);

                    await action();

                    if (type === 'create') {
                        this.state.createRepeatCount++;
                        countEl.textContent = `å·²å‘é€è¯·æ±‚: ${this.state.createRepeatCount} æ¬¡`;
                    } else if (type === 'reconfig') {
                        this.state.reconfigRepeatCount++;
                        countEl.textContent = `å·²å‘é€è¯·æ±‚: ${this.state.reconfigRepeatCount} æ¬¡`;
                    } else {
                        this.state.powerRepeatCount++;
                        countEl.textContent = `å·²å‘é€è¯·æ±‚: ${this.state.powerRepeatCount} æ¬¡`;
                    }
                };

                runLoop();

                const timerId = setInterval(runLoop, interval * 1000);

                if (type === 'create') this.state.createIntervalId = timerId;
                else if (type === 'reconfig') this.state.reconfigIntervalId = timerId;
                else this.state.powerIntervalId = timerId;
            },

            stopAutoCreate() {
                if (this.state.createIntervalId) {
                    clearInterval(this.state.createIntervalId);
                    this.state.createIntervalId = null;
                }
                this.elements.autoCreateBtn.textContent = 'å¼€å§‹å¾ªç¯åˆ›å»º';
                this.elements.intervalInput.disabled = false;
                this.elements.createProgressContainer.style.display = 'none';
                this.elements.createProgressBar.style.width = '0%';
            },

            stopAutoReconfig() {
                if (this.state.reconfigIntervalId) {
                    clearInterval(this.state.reconfigIntervalId);
                    this.state.reconfigIntervalId = null;
                }
                this.elements.autoReconfigureBtn.textContent = 'å¼€å§‹å¾ªç¯å˜é…';
                this.elements.instanceIntervalInput.disabled = false;
                this.elements.reconfigProgressContainer.style.display = 'none';
                this.elements.reconfigProgressBar.style.width = '0%';
            },

            stopAutoPower() {
                if (this.state.powerIntervalId) {
                    clearInterval(this.state.powerIntervalId);
                    this.state.powerIntervalId = null;
                }
                this.elements.autoStartBtn.textContent = 'å¼€å§‹å¾ªç¯å¼€æœº';
                this.elements.powerIntervalInput.disabled = false;
                this.elements.powerProgressContainer.style.display = 'none';
                this.elements.powerProgressBar.style.width = '0%';
            },

            toggleLoading(isLoading) {
                this.elements.loadingArea.style.display = isLoading ? 'block' : 'none';
            },

            async submitToken() {
                const token = this.elements.tokenInput.value.trim();
                if (!token) return Toast.warning('è¯·è¾“å…¥ Token');

                const btn = this.elements.submitTokenBtn;
                const originalText = btn.textContent;
                btn.disabled = true;
                btn.textContent = 'éªŒè¯ä¸­...';

                try {
                    // ä¸´æ—¶ä½¿ç”¨è¾“å…¥çš„ token è¿›è¡ŒéªŒè¯
                    this.state.token = token;
                    await this.getUserInfo();

                    // éªŒè¯é€šè¿‡ï¼Œä¿å­˜ Token
                    this.setCookie('sf_token', encodeURIComponent(token), 30);
                    this.elements.tutorial.classList.remove('expanded');
                    this.elements.refreshBtn.style.display = 'block';
                    Toast.success('Token éªŒè¯é€šè¿‡å¹¶å·²ä¿å­˜');
                    this.refreshData();
                } catch (error) {
                    this.state.token = null; // éªŒè¯å¤±è´¥ï¼Œé‡ç½® state
                    Toast.error(`Token æ— æ•ˆ: ${error.message}`);
                } finally {
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            },

            clearToken(refresh = true) {
                this.deleteCookie('sf_token');
                this.state.token = null;
                this.elements.tokenInput.value = '';
                this.elements.tutorial.classList.add('expanded');
                this.elements.refreshBtn.style.display = 'none';
                this.elements.createActionArea.classList.add('hidden');
                this.elements.reconfigActionArea.classList.add('hidden');
                this.elements.configBody.innerHTML = '';
                this.elements.instancesBody.innerHTML = '';
                if (refresh) Toast.warning('Token å·²æ¸…é™¤');
            },

            setCookie(name, value, days) {
                const date = new Date();
                date.setTime(date.getTime() + days * 24 * 60 * 60 * 1000);
                document.cookie = `${name}=${value};expires=${date.toUTCString()};path=/`;
            },

            getCookie(name) {
                const cookies = document.cookie.split('; ');
                for (const cookie of cookies) {
                    const [k, v] = cookie.split('=');
                    if (k === name) return decodeURIComponent(v);
                }
                return null;
            },

            deleteCookie(name) {
                this.setCookie(name, '', -1);
            }
        };

        window.addEventListener('load', () => simpCreateApp.init());
    </script>
</body>

</html>